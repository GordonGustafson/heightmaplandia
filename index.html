<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
      <title>HeightMapLandia</title>
	  
		<style>
			html, body {
			overflow: hidden;
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;
			}

			#renderCanvas {
			width: 100%;
			height: 100%;
			touch-action: none;
			}
		</style>
	  
		<script src="js/lib/babylon.js"></script>
		<script src="js/lib/hand.js"></script>
		<script src="js/lib/cannon.js"></script>	  
		
   </head>

   <body>
		<canvas id="renderCanvas"></canvas>		
		<script id="groundVertexShader"  type="x-shader/x-vertex">
precision highp float;

attribute vec3 position;
attribute vec3 normal;

uniform mat4 worldViewProjection;

varying vec4 vPosition;
varying vec3 vNormal;
varying vec3 vLight;

void main() {
    vPosition = vec4( position, 1. );
    vNormal = normalize(normal);
    vLight = normalize(vec3(.6,.5,-.2));//This is terrible hack

    gl_Position = worldViewProjection * vPosition;
}
        </script>
		<script id="groundFragmentShader" type="x-shader/x-fragment">
precision highp float;

varying vec4 vPosition;
varying vec3 vNormal;
varying vec3 vLight;

// assume the minimum terrain height is 0
uniform float MAX_TERRAIN_HEIGHT;

uniform sampler2D rockSampler;
uniform sampler2D grassSampler;
uniform sampler2D snowSampler;

void main() {
    float fractionOfMaxTerrainHeight = vPosition.y / MAX_TERRAIN_HEIGHT;

    const int NUMBER_OF_TEXTURES = 3;
    vec4 TEXTURE_COLORS_AT_CURRENT_XZ[NUMBER_OF_TEXTURES];
    TEXTURE_COLORS_AT_CURRENT_XZ[0] = texture2D(rockSampler,  vPosition.xz);
    TEXTURE_COLORS_AT_CURRENT_XZ[1] = texture2D(grassSampler, vPosition.xz);
    TEXTURE_COLORS_AT_CURRENT_XZ[2] = texture2D(snowSampler,  vPosition.xz);

    // If vPosition.y falls between two values adjacent in this array, linearly interpolate
    // the colors of the corresponding textures. Otherwise, use only the top or bottom texture.
    float TEXTURE_BOUNDARY_HEIGHTS[NUMBER_OF_TEXTURES];
    TEXTURE_BOUNDARY_HEIGHTS[0] = 0.05;
    TEXTURE_BOUNDARY_HEIGHTS[1] = 0.50;
    TEXTURE_BOUNDARY_HEIGHTS[2] = .95;

    vec4 diffColor;

    if        (fractionOfMaxTerrainHeight < TEXTURE_BOUNDARY_HEIGHTS[0]) {
        diffColor = TEXTURE_COLORS_AT_CURRENT_XZ[0];
    } else if (fractionOfMaxTerrainHeight > TEXTURE_BOUNDARY_HEIGHTS[NUMBER_OF_TEXTURES - 1]) {
        diffColor = TEXTURE_COLORS_AT_CURRENT_XZ[NUMBER_OF_TEXTURES - 1];
    } else {
        for (int i = 0; i < NUMBER_OF_TEXTURES - 1; i++) {
            float lowHeightBoundary  = TEXTURE_BOUNDARY_HEIGHTS[i];
            float highHeightBoundary = TEXTURE_BOUNDARY_HEIGHTS[i+1];
            if (fractionOfMaxTerrainHeight > lowHeightBoundary &&
                fractionOfMaxTerrainHeight < highHeightBoundary) {
                float fractionBetweenHeightBoundaries = (fractionOfMaxTerrainHeight - lowHeightBoundary) /
                                                                (highHeightBoundary - lowHeightBoundary);
                vec4 lowTextureColor  = TEXTURE_COLORS_AT_CURRENT_XZ[i];
                vec4 highTextureColor = TEXTURE_COLORS_AT_CURRENT_XZ[i+1];
                diffColor = mix(lowTextureColor, highTextureColor, fractionBetweenHeightBoundaries);
            }
        }
    }

    diffColor.xyz = diffColor.xyz * (dot(vNormal,vLight)*0.85);
    gl_FragColor = diffColor;
}
        </script>
		<script src="js/world.js"></script>        
		<div style="position: absolute;  color: white;  bottom: 5px; right: 5px;">H - Toggle Help Menu</div>
		<div style="position: absolute;  color: white;  top: 5px; right: 5px; display: none;" id="pos">
          <table>
            <tr> <td>X:</td> <td id="positionX"></td> </tr>
            <tr> <td>Y:</td> <td id="positionY"></td> </tr>
            <tr> <td>Z:</td> <td id="positionZ"></td> </tr>
            </table>
        </div>
        <div id="loading" style="position: absolute; width: 100%; height: 100%; background-color: black; top:1px; opacity: .5; color:white; z-index:10;">
            <div style="position: relative; margin-top: 15%; text-align: center;">
                <h1 style="font-size: 600%; text-align: center; margin-bottom:8%;">HeightMapLandia</div>
                <h1 id="loadingcontent" style="color: white; text-align: center;">Loading...</h1>
                <div style="position: absolute; bottom: 0;" >Song: "Soft Theme".  Artist: J. Cassard</div>
            </div>
        </div>
        <div id="victory" style="position: absolute; width: 100%; height: 100%; background-color: black; top:1px; opacity: .5; color:white; z-index:10; display: none;">
            <div style="position: relative; margin-top: 15%; text-align: center;">
                <h1 style="font-size: 600%; text-align: center; margin-bottom:8%;">You've Won!</div>
                <!--http://www.hibou-music.com/main-1445-1.html-->
            </div>
        </div>
        <div id="reticle" style="position: absolute; top: 49%; left: 49%;">+</div>
        <div id="helpMenu" style="position: absolute; width: 100%; height: 100%; background-color: black; top:1px; opacity: .5; color:white; z-index:10; display: none;">
            <div style="position: relative; margin-top: 15%; text-align: center;">
                <h1 style="font-size: 600%; text-align: center; margin-bottom:8%;">Controls</div>
                <ul id="loadingcontent" style="color: white; text-align: center; list-style-type: none; margin-top: -5%;">
                    <li>W - Move Forward</li>
                    <li>A - Move Left</li>
                    <li>S - Move Backwards</li>
                    <li>A - Move Right</li><br>
                    <li>M - Toggle Music</li>
                    <li>H - Toggle Help Menu</li>                    
                    <li>P - Toggle Game Parameters Menu</li>
                    <li>G - Toggle God Mode (Enables Sprint)</li>
                    <li>LShift - Sprint<li>
                    <li>ESC - Uncapture Mouse Pointer</li>
                </ul>
                <div style="position: absolute; bottom: 0;" >Song: "Soft Theme".  Artist: J. Cassard</div>
            </div>
        </div>
        <div id="params" style="color:white; position: absolute; right: 10px; top: 30%; display: none;">
            <h1 >Game Parameters</h1>
            <strong>Player Speed:</strong> <input type="text" id="speed"><br>
            <strong>World Gravity:</strong> <input type="text" id="gravity"><br><br>
            <button id="paramButton">Update Parameters</button>
        
        </div>
        
   </body>

</html>
